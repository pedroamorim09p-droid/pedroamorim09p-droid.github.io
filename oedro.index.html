<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Polo Empresarial — Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#041426; --card:#07263a; --accent:#d4af37; --muted:#98a2b3;
  --green:#0f9d58; --red:#d93025; --blue:#6fd0ff;
}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#021521);color:#e8f4fb}

/* LOGIN OVERLAY */
#loginOverlay{
  position:fixed;left:0;top:0;right:0;bottom:0;
  background:linear-gradient(180deg, rgba(2,6,10,0.95), rgba(2,6,10,0.98));
  display:flex;align-items:center;justify-content:center;z-index:9999;
}
#loginCard{width:360px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:22px;border:1px solid rgba(255,255,255,0.03)}
#loginCard h3{color:var(--accent);margin-bottom:12px}
#loginCard .mini{color:var(--muted);font-size:13px}

/* Restante do estilo existente */
header{height:64px;display:flex;align-items:center;gap:12px;padding:12px 18px}
.hamb{width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-direction:column;gap:4px}
.hamb span{display:block;width:24px;height:2px;background:var(--accent)}
.brand{font-weight:700;font-size:18px}
.container-main{display:flex;gap:18px;padding:18px}
aside.sidebar{width:260px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
main.board{flex:1;display:flex;flex-direction:column;gap:12px}
.card-panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));border-radius:12px;padding:14px;margin-bottom:14px;border:1px solid rgba(255,255,255,0.03)}
.muted{color:var(--muted)}
.big-value{font-size:28px;font-weight:800;color:#fff}
.sectors-grid{display:flex;flex-direction:column;gap:12px}
.sector-card{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);cursor:pointer}
.toggle-ico{font-size:14px;margin-left:8px;color:var(--muted)}
.chart-wrap{height:220px}
.mini{font-size:13px;color:var(--muted)}
.btn-outline-light{color:#e8f4fb;border-color:rgba(255,255,255,0.2)}
.btn-outline-light:hover{background:var(--accent);border-color:var(--accent);color:#041426}

/* Modal Custom */
.modal-custom .modal-content{background:linear-gradient(180deg,rgba(4,20,38,0.95),rgba(7,38,58,0.95));border:1px solid rgba(212,175,55,0.7);border-radius:12px;color:#fff}
.modal-custom .modal-header,.modal-custom .modal-footer{border:none}
.modal-custom .btn-outline-light{color:#fff;border-color:rgba(212,175,55,0.7)}
.modal-custom .btn-outline-light:hover{background:var(--accent);border-color:var(--accent);color:#041426}

/* Modal Histórico */
.modal-historico .modal-content{background:linear-gradient(180deg,rgba(4,20,38,0.95),rgba(7,38,58,0.95));border:1px solid rgba(212,175,55,0.7);border-radius:12px;color:#fff}
.modal-historico .nav-tabs .nav-link{color:#fff}
.modal-historico .nav-tabs .nav-link.active{background:var(--accent);color:#041426;border-radius:6px}

/* Modal Equipe */
.modal-equipe .modal-content{background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03));border:1px solid rgba(255,255,255,0.08);border-radius:12px}

/* Modal Setores */
.modal-setores .modal-content{background:linear-gradient(180deg,rgba(4,20,38,0.95),rgba(7,38,58,0.95));border:1px solid rgba(212,175,55,0.7);border-radius:12px;color:#fff}

/* Menu esquerda */
#modalMenu .modal-dialog { position: fixed; left: 0; right: auto; margin: 0; height: 100%; max-width: 360px; }
#modalMenu .modal-content { height: 100%; border-radius: 0 12px 12px 0; display: flex; flex-direction: column; }
</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay">
  <div id="loginCard">
    <h3>Entrar — Polo Empresarial</h3>
    <div class="mb-2">
      <input id="loginUser" class="form-control form-control-sm" placeholder="Usuário">
    </div>
    <div class="mb-2">
      <input id="loginPass" type="password" class="form-control form-control-sm" placeholder="Senha">
    </div>
    <div class="d-flex gap-2">
      <button id="btnLogin" class="btn btn-outline-light btn-sm flex-grow-1">Entrar</button>
      
    </div>
    <div class="mt-2 mini" id="loginMsg"></div>
    
  </div>
</div>

<header>
  <div class="hamb" id="btnMenu"><span></span><span></span><span></span></div>
  <div class="brand">Polo Empresarial</div>
</header>

<div class="container-main">
  <aside class="sidebar">
    <div class="card-panel" id="resumoAtual">
  <button class="btn btn-outline-light btn-sm d-none" id="btnEditarResumoAtual">Editar Resumo</button>
      <div class="muted mini">Resumo Atual</div>
      <div class="big-value" id="totalFatur">R$ 100.000</div>
      <div class="muted mini">Mês: <b id="mesAtual">2025-08</b></div>
      <div class="mini mt-2">Gasto: <b id="gastoAtual">R$ 40.000</b></div>
      <div class="mini">Lucro: <b id="lucroAtual" style="color:var(--green)">+ R$ 60.000 (60%)</b></div>
    </div>
  </aside>

  <main class="board" id="mainBoard"></main>
</div>

<!-- Modal Equipe -->
<div class="modal fade modal-equipe" id="modalEquipe" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h5 class="modal-title" id="modalEquipeTitulo">Equipe do Setor</h5>
      <div class="mb-2 mt-2">
        <label class="form-label mini">Valor a distribuir:</label>
        <input type="text" class="form-control form-control-sm formatar-numero" id="inputValorDistribuir">
      </div>
      <div id="equipeModalContainer" class="mt-2"></div>
      <div class="mt-2 mini" id="infoDistribuicao"></div>
      <div class="mt-3 text-end">
        <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Menu -->
<div class="modal fade modal-custom" id="modalMenu" tabindex="-1">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content p-3">
      <h5 class="modal-title">Menu</h5>
      <div class="mt-3 d-grid gap-2">
        <button class="btn btn-outline-light btn-sm" id="btnLogoutMenu">Sair</button>
        <button class="btn btn-outline-light btn-sm" id="btnEditarSetoresMenu">Editar Setores</button>
        <button class="btn btn-outline-light btn-sm" id="btnEditarEquipeMenu">Editar Equipe</button>
        <button class="btn btn-outline-light btn-sm" id="btnResumoMenu">Ver Resumo</button>
        <button class="btn btn-outline-light btn-sm" id="btnHistoricoMenu">Histórico</button>
        <button class="btn btn-outline-light btn-sm d-none" id="btnUsuariosMenu">Gerenciar Logins</button>
      </div>
      <div class="mt-3 text-end">
        <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Setores -->
<div class="modal fade modal-setores" id="modalSetores" tabindex="-1">
  <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content p-3">
      <h5 class="modal-title">Editar Setores</h5>
      <div id="setoresModalContent" class="mt-2"></div>
      <div class="mt-3 text-end">
        <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Resumo -->
<div class="modal fade modal-setores" id="modalResumo" tabindex="-1">
  <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content p-3">
      <h5 class="modal-title">Resumo Mensal e Anual</h5>
      <div id="resumoModalContent" class="mt-2"></div>
      <div class="mt-3 text-end">
        <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Histórico -->
<div class="modal fade modal-historico" id="modalHistorico" tabindex="-1">
  <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content p-3">
      <h5 class="modal-title">Histórico de Alterações</h5>
      <ul class="nav nav-tabs mt-3" id="historicoTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" id="pessoas-tab" data-bs-toggle="tab" data-bs-target="#pessoasTab">Pessoas</button></li>
        <li class="nav-item"><button class="nav-link" id="setores-tab" data-bs-toggle="tab" data-bs-target="#setoresTab">Setores</button></li>
      </ul>
      <div class="tab-content mt-2" id="historicoContent">
        <div class="tab-pane fade show active" id="pessoasTab"></div>
        <div class="tab-pane fade" id="setoresTab"></div>
      </div>
      <div class="mt-3 text-end">
        <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Escolher Setor para Editar Equipe -->
<div class="modal fade modal-custom" id="modalEscolherEquipe" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h5 class="modal-title">Escolher Setor para editar equipe</h5>
      <div id="escolherEquipeContainer" class="mt-2"></div>
      <div class="mt-3 text-end">
        <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Gerenciar Usuários -->
<div class="modal fade modal-custom" id="modalUsuarios" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h5 class="modal-title">Gerenciar Usuários</h5>
      <div id="usuariosContainer" class="mt-2"></div>
      <button class="btn btn-outline-light btn-sm mt-2" id="btnAddUsuario">Adicionar Usuário</button>
      <div class="mt-3 text-end">
        <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script>
// ===== Dados =====
let totalMes = 100000;
let gastoMes = 40000;
let setores = [
  { id:'s1', nome:'Telemedicina', pct:40, serieAnual:[], serieMensal:[], pessoas:[ { nome:'João', pct:50 }, { nome:'Maria', pct:30 }, { nome:'Carlos', pct:20 } ]},
  { id:'s2', nome:'Tok Leilões', pct:20, serieAnual:[], serieMensal:[], pessoas:[ { nome:'Ana', pct:40 }, { nome:'Paulo', pct:35 }, { nome:'Julia', pct:25 } ]},
  { id:'s3', nome:'QuintoIMOB', pct:25, serieAnual:[], serieMensal:[], pessoas:[ { nome:'Lucas', pct:60 }, { nome:'Fernanda', pct:25 }, { nome:'Bruno', pct:15 } ]},
  { id:'s4', nome:'Jurídico', pct:15, serieAnual:[], serieMensal:[], pessoas:[ { nome:'Rafaela', pct:50 }, { nome:'Diego', pct:30 }, { nome:'Larissa', pct:20 } ] }
];
function genSerie(n,min,max){ return Array.from({length:n},()=>Math.round(min+Math.random()*(max-min))); }
setores.forEach(s=>{ s.serieAnual=genSerie(12,5000,20000); s.serieMensal=genSerie(12,5000,15000); });

// ===== Resumo =====
function atualizarResumo(){
  document.getElementById('totalFatur').textContent = 'R$ ' + totalMes.toLocaleString('pt-BR');
  document.getElementById('gastoAtual').textContent = 'R$ ' + gastoMes.toLocaleString('pt-BR');
  const lucro = totalMes - gastoMes;
  const pct = Math.round(lucro/totalMes*100);
  const lucroEl = document.getElementById('lucroAtual');
  lucroEl.textContent = (lucro>=0?'+ ':'- ') + 'R$ ' + Math.abs(lucro).toLocaleString('pt-BR') + ` (${isFinite(pct)?pct:0}%)`;
  lucroEl.style.color = lucro>=0? 'var(--green)' : 'var(--red)';
}

// ===== Dashboard =====
const mainBoard = document.getElementById('mainBoard');
let setorAberto = null;
const modalEquipe = new bootstrap.Modal(document.getElementById('modalEquipe'));
let setorAtual = null;

function renderDashboard(){
  mainBoard.innerHTML = '';
  let listaSetores = setores;
  // se usuário estiver logado e for tipo setor, filtra só seu setor (usa nome do setor salvo no usuário)
  if(usuarioLogado && usuarioLogado.tipo === "setor" && usuarioLogado.setor){
    listaSetores = setores.filter(s => s.nome === usuarioLogado.setor);
  }
  listaSetores.forEach(s=>{
    const card = document.createElement('div');
    card.className='card-panel sector-card';
    const ganhoSetor=Math.round(totalMes*(s.pct/100));
    card.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer">
        <div><strong>${s.nome}</strong><br><span class="mini muted">Contribuição: ${s.pct}% — R$ ${ganhoSetor.toLocaleString('pt-BR')}</span></div>
        <div class="toggle-ico">+</div>
      </div>
      <div class="sector-body d-none mt-2">
        <button class="btn btn-outline-light btn-sm btnVerEquipe mb-2">Ver Equipe</button>
        <div class="chart-wrap"><canvas id="chartMensal_${s.id}"></canvas></div>
        <div class="chart-wrap mt-2"><canvas id="chartAnual_${s.id}"></canvas></div>
      </div>
    `;
    mainBoard.appendChild(card);

    const toggle = card.querySelector('.toggle-ico');
    const body = card.querySelector('.sector-body');
    card.querySelector('div:first-child').addEventListener('click',()=>{
      if(setorAberto && setorAberto!==body){
        setorAberto.classList.add('d-none');
        setorAberto.previousElementSibling.querySelector('.toggle-ico').textContent='+';
      }
      if(body.classList.contains('d-none')){ body.classList.remove('d-none'); toggle.textContent='-'; setorAberto=body; }
      else { body.classList.add('d-none'); toggle.textContent='+'; setorAberto=null; }

      // Render gráficos com cores verde/vermelho
      const coresMensal = s.serieMensal.map(v => v >= 0 ? '#0f9d58' : '#d93025');
      new Chart(body.querySelector(`#chartMensal_${s.id}`),{
        type:'bar',
        data:{labels:['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],datasets:[{label:'Faturamento Mensal',data:s.serieMensal,backgroundColor:coresMensal}]},
        options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
      });

      const totalAnual = s.serieAnual.reduce((a,b)=>a+b,0);
      const corAnual = totalAnual >=0 ? '#0f9d58' : '#d93025';
      new Chart(body.querySelector(`#chartAnual_${s.id}`),{
        type:'line',
        data:{labels:['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],datasets:[{label:'Faturamento Anual',data:s.serieAnual,backgroundColor:'rgba(111,208,255,0.2)',borderColor:corAnual,tension:0.3,fill:true}]},
        options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
      });
    });

    card.querySelector('.btnVerEquipe').addEventListener('click', e=>{
      e.stopPropagation();
      abrirModalEquipe(s);
    });
  });
}

// ===== Modal Equipe (com controle de permissão: só admin pode editar) =====
function abrirModalEquipe(setor){
  setorAtual=setor;
  document.getElementById('modalEquipeTitulo').textContent = 'Equipe do Setor — ' + setor.nome;

  setorAtual=setor;
  const inputValor=document.getElementById('inputValorDistribuir');
  inputValor.value = setor.valorDistribuir||'';
  inputValor.oninput = () => {
    // remove tudo que não for número ou ponto
    let val = inputValor.value.replace(/[^0-9.]/g, '');
    setor.valorDistribuir = parseFloat(val) || 0;
    // reformatar no estilo americano com vírgula
    inputValor.value = setor.valorDistribuir.toLocaleString('en-US');
    atualizarDistribuicao();
};

  const container=document.getElementById('equipeModalContainer');
  container.innerHTML='';

  // se usuario logado não é admin, bloqueia edição
  const podeEditar = usuarioLogado && usuarioLogado.tipo === 'admin';

  setor.pessoas.forEach((p,i)=>{
    const div=document.createElement('div');
    div.className='mb-1';
    const idValor = `valorPessoa_${setor.id}_${i}`;
    // inputs desabilitados se não pode editar
    div.innerHTML=`
      <div class="row g-2 align-items-center">
        <div class="col-6"><input type="text" ${podeEditar?'':'disabled'} class="form-control form-control-sm pessoa-nome" value="${p.nome}" data-idx="${i}" data-field="nome"></div>
        <div class="col-3"><input type="number" step="0.01" ${podeEditar?'':'disabled'} class="form-control form-control-sm pessoa-pct" value="${p.pct}" data-idx="${i}" data-field="pct"></div>
        <div class="col-2"><span class="mini" id="${idValor}"></span></div>
        <div class="col-1 text-end">${podeEditar?`<button class="btn btn-sm btn-outline-light btnDelPessoa" data-idx="${i}" title="Excluir pessoa">×</button>`:''}</div>
      </div>
    `;
    container.appendChild(div);

    if(podeEditar){
      const inputs = div.querySelectorAll('input');
      inputs.forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const idx = parseInt(inp.dataset.idx);
          const f = inp.dataset.field;
          if(f==='nome') setor.pessoas[idx].nome = inp.value;
          else if(f==='pct') setor.pessoas[idx].pct = parseFloat(inp.value)||0;
          atualizarDistribuicao();
        });
      });
      const delBtn = div.querySelector('.btnDelPessoa');
      delBtn.addEventListener('click', ()=>{
        const idx = parseInt(delBtn.dataset.idx);
        setor.pessoas.splice(idx,1);
        abrirModalEquipe(setor); // re-render modal
        renderDashboard();
      });
    }
  });

  // adicionar área de adicionar pessoa (só para admin)
  if(podeEditar){
    const addDiv=document.createElement('div');
    addDiv.className='mt-2';
    addDiv.innerHTML=`
      <div class="row g-2">
        <div class="col-7"><input id="novaPessoaNome_${setor.id}" class="form-control form-control-sm" placeholder="Nome da nova pessoa"></div>
        <div class="col-3"><input id="novaPessoaPct_${setor.id}" type="number" step="0.01" class="form-control form-control-sm" placeholder="%"></div>
        <div class="col-2 text-end"><button id="btnAddPessoa_${setor.id}" class="btn btn-outline-light btn-sm">Adicionar</button></div>
      </div>
    `;
    container.appendChild(addDiv);
    document.getElementById(`btnAddPessoa_${setor.id}`).addEventListener('click', ()=>{
      const nome = document.getElementById(`novaPessoaNome_${setor.id}`).value.trim() || 'Novo';
      const pct = parseFloat(document.getElementById(`novaPessoaPct_${setor.id}`).value) || 0;
      setor.pessoas.push({ nome, pct });
      // reabrir modal (re-render)
      abrirModalEquipe(setor);
      renderDashboard();
    });
  }

  atualizarDistribuicao();
  modalEquipe.show();
}

// ===== Distribuição =====
function atualizarDistribuicao(){
  if(!setorAtual) return;
  const totalValor = setorAtual.valorDistribuir||0;
  let somaPcts = setorAtual.pessoas.reduce((a,p)=>a + (parseFloat(p.pct)||0),0);
  let distribuido = 0;

  setorAtual.pessoas.forEach((p,i)=>{
    const pct = parseFloat(p.pct) || 0;
    const val = totalValor * (pct / 100);
    distribuido += val;
    const formatted = val.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
    const el = document.getElementById(`valorPessoa_${setorAtual.id}_${i}`);
    if(el) el.textContent = 'R$ '+formatted;
  });

  const faltaValor = totalValor - distribuido;
  const faltaPct = 100 - somaPcts;

  const infoEl = document.getElementById('infoDistribuicao');
  if(infoEl) infoEl.textContent =
    `Distribuído: R$ ${distribuido.toLocaleString('pt-BR', {minimumFractionDigits:2})} | `+
    `Falta: R$ ${faltaValor.toLocaleString('pt-BR', {minimumFractionDigits:2})} | `+
    `% usado: ${somaPcts.toFixed(2)}% | `+
    `% restante: ${faltaPct.toFixed(2)}%`;
}

// ===== Menu Modais =====
const modalMenu = new bootstrap.Modal(document.getElementById('modalMenu'));
const modalSetores = new bootstrap.Modal(document.getElementById('modalSetores'));
const modalResumo = new bootstrap.Modal(document.getElementById('modalResumo'));
const modalHistorico = new bootstrap.Modal(document.getElementById('modalHistorico'));

document.getElementById('btnMenu').addEventListener('click',()=>modalMenu.show());
document.getElementById('btnEditarSetoresMenu').addEventListener('click',()=>{ renderModalSetores(); modalSetores.show(); });
document.getElementById('btnResumoMenu').addEventListener('click',()=>{ renderModalResumo(); modalResumo.show(); });
document.getElementById('btnHistoricoMenu').addEventListener('click',()=>{ renderModalHistorico(); modalHistorico.show(); });

// ===== Modal Setores =====
function renderModalSetores(){
  const container=document.getElementById('setoresModalContent');
  container.innerHTML='';
  const podeEditarSetores = usuarioLogado && usuarioLogado.tipo === 'admin';
  setores.forEach((s,i)=>{
    const div=document.createElement('div');
    div.className='mb-2';
    div.innerHTML=`
      <div class="row g-2 align-items-center">
        <div class="col-6"><input type="text" ${podeEditarSetores?'':'disabled'} class="form-control form-control-sm" value="${s.nome}" data-idx="${i}" data-field="nomeSetor"></div>
        <div class="col-3"><input type="number" ${podeEditarSetores?'':'disabled'} class="form-control form-control-sm" value="${s.pct}" data-idx="${i}" data-field="pctSetor"></div>
        <div class="col-3 text-end">
          ${podeEditarSetores?`<button class="btn btn-sm btn-outline-light me-1" data-idx="${i}" id="delSetor_${i}">Excluir</button>`:''}
          ${podeEditarSetores?`<button class="btn btn-sm btn-outline-light btnEditarResumoSetor" data-idx="${i}">Editar Resumo</button>`:''}
        </div>
      </div>
    `;
    container.appendChild(div);
    if(podeEditarSetores){
      div.querySelector(`#delSetor_${i}`)?.addEventListener('click',()=>{
        setores.splice(i,1);
        renderModalSetores();
        renderDashboard();
        gerarGraficoMensal();
        gerarGraficoAnual();
      });
      div.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('input',()=>{
          const idx=parseInt(inp.dataset.idx);
          if(inp.dataset.field==='nomeSetor') setores[idx].nome=inp.value;
          else setores[idx].pct=parseFloat(inp.value)||0;
          renderDashboard();
          gerarGraficoMensal();
          gerarGraficoAnual();
        });
      });
    }
  });
  // attach listeners for Editar Resumo buttons
  document.querySelectorAll('.btnEditarResumoSetor').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const idx = parseInt(btn.dataset.idx);
      abrirModalEditarResumoSetor(setores[idx]);
    });
  });

  if(podeEditarSetores){
    const addBtn=document.createElement('button');
    addBtn.className='btn btn-outline-light btn-sm mt-2';
    addBtn.textContent='Adicionar Setor';
    addBtn.addEventListener('click',()=>{
      const newId = 's' + (setores.length + 1);
      setores.push({id:newId,nome:'Novo Setor',pct:0,serieAnual:[],serieMensal:[],pessoas:[], faturamentoMes:0, gastoMes:0, lucroMes:0});
      setores[setores.length-1].serieAnual = genSerie(12,5000,20000);
      setores[setores.length-1].serieMensal = genSerie(12,5000,15000);
      renderModalSetores();
      renderDashboard();
      gerarGraficoMensal();
      gerarGraficoAnual();
    });
    container.appendChild(addBtn);
  } else {
    const note = document.createElement('div');
    note.className = 'mini muted mt-2';
    note.textContent = 'Somente administradores podem editar setores.';
    container.appendChild(note);
  }
}

// ===== Modal Resumo =====
function renderModalResumo(){
  const container=document.getElementById('resumoModalContent');
  container.innerHTML='';
  setores.forEach(s=>{
    const ganhoMes=Math.round(totalMes*(s.pct/100));
    const gastoSetor=gastoMes*(s.pct/100);
    const lucro=ganhoMes-gastoSetor;
    const div=document.createElement('div');
    div.className='mb-2';
    div.innerHTML=`<div><strong>${s.nome}</strong></div>
      <div class="mini">Mensal: R$ ${ganhoMes.toLocaleString('pt-BR')} — Gasto: R$ ${gastoSetor.toLocaleString('pt-BR')} — Lucro: R$ ${lucro.toLocaleString('pt-BR')}</div>
      <div class="mini">Anual: R$ ${s.serieAnual.reduce((a,b)=>a+b,0).toLocaleString('pt-BR')}</div><hr>`;
    container.appendChild(div);
  });
}

// ===== Modal Histórico =====
function renderModalHistorico(){
  document.getElementById('pessoasTab').innerHTML='';
  document.getElementById('setoresTab').innerHTML='';
  setores.forEach(s=>{
    s.pessoas.forEach(p=>{
      const div=document.createElement('div');
      div.className='mb-1';
      div.textContent=`Pessoa: ${p.nome} — Setor: ${s.nome} — %: ${p.pct}`;
      document.getElementById('pessoasTab').appendChild(div);
    });
    const divSetor=document.createElement('div');
    divSetor.className='mb-1';
    divSetor.textContent=`Setor: ${s.nome} — %: ${s.pct}`;
    document.getElementById('setoresTab').appendChild(divSetor);
  });
}

// ===== Modal Escolher Equipe (restaura comportamento antigo) =====
const modalEscolherEquipe = new bootstrap.Modal(document.getElementById('modalEscolherEquipe'));
document.getElementById('btnEditarEquipeMenu').addEventListener('click', ()=> {
  renderModalEquipeMenu();
  modalEscolherEquipe.show();
});
function renderModalEquipeMenu(){
  const cont = document.getElementById('escolherEquipeContainer');
  cont.innerHTML = '';
  setores.forEach((s,i)=>{
    const btn = document.createElement('button');
    btn.className = 'btn btn-outline-light w-100 mb-2';
    btn.textContent = s.nome;
    btn.addEventListener('click', ()=>{ modalEscolherEquipe.hide(); abrirModalEquipe(s); });
    cont.appendChild(btn);
  });
}

// ===== Gerenciar Usuários (apenas admin pode ver o modal completo) =====
const modalUsuarios = new bootstrap.Modal(document.getElementById("modalUsuarios"));
document.getElementById("btnUsuariosMenu").addEventListener("click",()=>{ renderUsuarios(); modalUsuarios.show(); });

function renderUsuarios(){
  const cont=document.getElementById("usuariosContainer");
  cont.innerHTML="";
  usuarios.forEach((u,i)=>{
    const div=document.createElement("div");
    div.className="mb-2";
    // select de setores atualizável com nomes atuais
    const optionsSetores = setores.map(s => `<option value="${s.nome}" ${u.setor===s.nome?'selected':''}>${s.nome}</option>`).join('');
    div.innerHTML=`
      <input class="form-control form-control-sm mb-1" value="${u.usuario}" data-idx="${i}" data-field="usuario" placeholder="usuario">
      <input class="form-control form-control-sm mb-1" value="${u.senha}" data-idx="${i}" data-field="senha" placeholder="senha">
      <select class="form-control form-control-sm mb-1" data-idx="${i}" data-field="tipo">
        <option value="admin" ${u.tipo==="admin"?"selected":""}>Admin</option>
        <option value="setor" ${u.tipo==="setor"?"selected":""}>Setor</option>
        <option value="convidado" ${u.tipo==="convidado"?"selected":""}>Convidado</option>
      </select>
      <select class="form-control form-control-sm mb-1" data-idx="${i}" data-field="setor">
        <option value="">(nenhum)</option>
        ${optionsSetores}
      </select>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-light" onclick="delUsuario(${i})">Excluir</button>
        <button class="btn btn-sm btn-outline-light" onclick="copyCreds(${i})">Copiar credenciais</button>
      </div>
      <hr>`;
    cont.appendChild(div);
    // attach listeners to inputs inside this div
    div.querySelectorAll("input,select").forEach(inp=>{
      inp.addEventListener("input",()=>{
        const idx=parseInt(inp.dataset.idx);
        usuarios[idx][inp.dataset.field]=inp.value;
        salvarUsuarios();
      });
    });
  });
}
function delUsuario(i){ usuarios.splice(i,1); salvarUsuarios(); renderUsuarios(); }
document.getElementById("btnAddUsuario").addEventListener("click",()=>{
  // novo usuário padrão: tipo setor (admin pode ajustar)
  usuarios.push({usuario:"novo",senha:"123",tipo:"setor",setor:setores[0]?setores[0].nome:null});
  salvarUsuarios();
  renderUsuarios();
});
function copyCreds(i){
  const u = usuarios[i];
  navigator.clipboard?.writeText(`usuario: ${u.usuario}  senha: ${u.senha}`).
    then(()=> alert('Credenciais copiadas para área de transferência')).
    catch(()=> alert(`Usuario: ${u.usuario} / Senha: ${u.senha}`));
}

// ===== Gráficos gerais =====
let graficoMensalInst,graficoAnualInst;
function gerarGraficoMensal(){
  const canvas = document.getElementById('graficoMensal');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const labels = setores.map(s=>s.nome);
  const dados = setores.map(s=>{ const lucro = (s.lucroMes!==undefined) ? s.lucroMes : ((s.faturamentoMes||0)-(s.gastoMes||0)); return lucro; });
  if(graficoMensalInst) graficoMensalInst.destroy();
  graficoMensalInst = new Chart(ctx,{ type:'bar', data:{ labels, datasets:[{ label:'Lucro Mensal', data:dados, backgroundColor:dados.map(v=> v>=0 ? '#0f9d58' : '#d93025')}]}, options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } } });
}

function gerarGraficoAnual(){
  const canvas = document.getElementById('graficoAnual');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const labels = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  const datasets = setores.map((s,idx)=>{
    const color = ['#0f9d58','#d93025','#6fd0ff','#d4af37'][idx % 4];
    return { label:s.nome, data:s.serieAnual.slice(), borderColor:color, backgroundColor:'rgba(255,255,255,0.03)', fill:true, tension:0.3 };
  });
  if(graficoAnualInst) graficoAnualInst.destroy();
  graficoAnualInst = new Chart(ctx,{
    type:'line',
    data:{ labels, datasets },
    options:{ responsive:true, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } }
  });
}

// ===== Inicializar =====
// criar elementos de gráficos gerais (colocados fora do mainBoard)
(function criarCanvasGerais(){
  // evita duplicar caso já existam
  if(!document.getElementById('graficoMensal')){
    const panel=document.createElement('div');
    panel.className='card-panel';
    panel.style.margin='18px';
    panel.innerHTML=`<div class="muted mini">Desempenho Geral</div>
      <ul class="nav nav-tabs" id="graficosTabs" role="tablist" style="margin-bottom:12px;">
        <li class="nav-item"><button class="nav-link active" id="tabMensalBtn" data-mode="mensal">Mensal</button></li>
        <li class="nav-item"><button class="nav-link" id="tabAnualBtn" data-mode="anual">Anual</button></li>
      </ul>
      <div id="graficosContainer">
        <div id="grafMensalWrap"><canvas id="graficoMensal" class="chart-wrap"></canvas></div>
        <div id="grafAnualWrap" style="display:none;"><canvas id="graficoAnual" class="chart-wrap"></canvas></div>
      </div>`;
    document.body.appendChild(panel);
  }
  if(!document.getElementById('graficoAnual')){
    const panel=document.createElement('div');
    panel.className='card-panel';
    panel.style.margin='18px';
    panel.innerHTML=`<div class="muted mini">Desempenho Anual Geral</div><canvas id="graficoAnual" class="chart-wrap"></canvas>`;
    document.body.appendChild(panel);
  }
})();

atualizarResumo();
renderDashboard();
gerarGraficoMensal();
gerarGraficoAnual();
</script>


<script>
// === Formatação Americana de Valores ===
function formatarNumeroAmericano(valor) {
  if (!valor) return "";
  valor = valor.replace(/[^0-9.]/g, "");
  let partes = valor.split(".");
  let inteiro = partes[0];
  let decimal = partes[1] ? "." + partes[1].substring(0,2) : "";
  inteiro = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  return inteiro + decimal;
}

document.querySelectorAll("input.formatar-numero").forEach(inp => {
  inp.addEventListener("input", () => {
    let cursorPos = inp.selectionStart;
    let antes = inp.value.length;
    inp.value = formatarNumeroAmericano(inp.value);
    let depois = inp.value.length;
    inp.selectionEnd = inp.selectionStart = cursorPos + (depois - antes);
  });
});
</script>

<!-- Modal Editar Resumo do Setor (individual) -->
<div class="modal fade modal-custom" id="modalEditarResumoSetor" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h5 class="modal-title" id="modalEditarResumoSetorTitulo">Resumo do Setor</h5>
      <div id="modalEditarResumoSetorBody" class="mt-2">
        <div class="mb-2">Faturamento (mês): <input id="inputFaturamentoMes" type="number" class="form-control form-control-sm"></div>
        <div class="mb-2">Gasto (mês): <input id="inputGastoMes" type="number" class="form-control form-control-sm"></div>
        <div class="mb-2">Lucro (mês): <input id="inputLucroMes" type="number" class="form-control form-control-sm"></div>
      </div>
      <div class="mt-3 text-end">
        <button type="button" class="btn btn-outline-light btn-sm" id="btnSalvarResumoSetor">Salvar</button>
        <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script>

// Persistência de setores
function salvarSetores(){ localStorage.setItem("setores", JSON.stringify(setores)); }
function carregarSetores(){ const dados = localStorage.getItem("setores"); if(dados){ try{ setores = JSON.parse(dados); }catch(e){ console.error("Erro ao carregar setores:", e); } } }
carregarSetores();

// abrir modal de edição do resumo de um setor
const modalEditarResumoSetor = new bootstrap.Modal(document.getElementById('modalEditarResumoSetor'));
let setorEditandoIdx = null;
function abrirModalEditarResumoSetor(setor){
  setorEditandoIdx = setores.findIndex(s=>s.id===setor.id);
  document.getElementById('modalEditarResumoSetorTitulo').textContent = 'Resumo do Setor — ' + setor.nome;
  document.getElementById('inputFaturamentoMes').value = setor.faturamentoMes || 0;
  document.getElementById('inputGastoMes').value = setor.gastoMes || 0;
  document.getElementById('inputLucroMes').value = (setor.lucroMes!==undefined) ? setor.lucroMes : ((setor.faturamentoMes||0)-(setor.gastoMes||0));
  modalEditarResumoSetor.show();
}
document.getElementById('btnSalvarResumoSetor')?.addEventListener('click', ()=>{
  if(setorEditandoIdx===null) return;
  const fatur = parseFloat(document.getElementById('inputFaturamentoMes').value) || 0;
  const gasto = parseFloat(document.getElementById('inputGastoMes').value) || 0;
  const lucro = parseFloat(document.getElementById('inputLucroMes').value) || (fatur - gasto);
  setores[setorEditandoIdx].faturamentoMes = fatur;
  setores[setorEditandoIdx].gastoMes = gasto;
  setores[setorEditandoIdx].lucroMes = lucro;
  salvarSetores();
  modalEditarResumoSetor.hide();
  renderModalSetores();
  renderDashboard();
  atualizarResumo();
  // refresh charts depending on mode
  if(window.viewMode === 'mensal') gerarGraficoMensal(); else gerarGraficoAnual();
});

// Graph view mode (mensal / anual) controls
window.viewMode = 'mensal';
function setViewMode(mode){
  window.viewMode = mode;
  const mensalWrap = document.getElementById('grafMensalWrap');
  const anualWrap = document.getElementById('grafAnualWrap');
  const tabMensal = document.getElementById('tabMensalBtn');
  const tabAnual = document.getElementById('tabAnualBtn');
  if(mode === 'mensal'){
    if(mensalWrap) mensalWrap.style.display = '';
    if(anualWrap) anualWrap.style.display = 'none';
    if(tabMensal) tabMensal.classList.add('active');
    if(tabAnual) tabAnual.classList.remove('active');
    gerarGraficoMensal();
  } else {
    if(mensalWrap) mensalWrap.style.display = 'none';
    if(anualWrap) anualWrap.style.display = '';
    if(tabMensal) tabMensal.classList.remove('active');
    if(tabAnual) tabAnual.classList.add('active');
    gerarGraficoAnual();
  }
}
// attach click handlers
document.addEventListener('click', function(e){
  if(e.target && e.target.id === 'tabMensalBtn'){ setViewMode('mensal'); }
  if(e.target && e.target.id === 'tabAnualBtn'){ setViewMode('anual'); }
});
// initialize viewMode after slight delay when page loads
window.addEventListener('load', ()=>{ setTimeout(()=> setViewMode(window.viewMode), 200); });


// ===== Logout =====
document.getElementById("btnLogoutMenu").addEventListener("click", ()=>{
  usuarioLogado = null;
  loginOverlay.style.display = "flex";
});

</script>

<!-- Modal Editar Resumo Atual -->
<div class="modal fade modal-custom" id="modalEditarResumoAtual" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h5 class="modal-title">Editar Resumo Atual</h5>
      <div class="mt-2">
        <div class="mb-2">Total: <input id="inputTotalMes" type="number" class="form-control form-control-sm"></div>
        <div class="mb-2">Gasto: <input id="inputGastoMesAtual" type="number" class="form-control form-control-sm"></div>
      </div>
      <div class="mt-3 text-end">
        <button type="button" class="btn btn-outline-light btn-sm" id="btnSalvarResumoAtual">Salvar</button>
        <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>


<script>
// ===== Fix: Editar Resumo Atual - funcionalidade completa =====
(function(){
  const btnEditar = document.getElementById('btnEditarResumoAtual');
  const modalEl = document.getElementById('modalEditarResumoAtual');
  const modal = modalEl ? new bootstrap.Modal(modalEl) : null;

  if(btnEditar){
    btnEditar.addEventListener('click', ()=>{
      // popular inputs com valores atuais
      const inpTotal = document.getElementById('inputTotalMes');
      const inpGasto = document.getElementById('inputGastoMesAtual');
      if(inpTotal) inpTotal.value = typeof totalMes !== 'undefined' ? totalMes : 0;
      if(inpGasto) inpGasto.value = typeof gastoMes !== 'undefined' ? gastoMes : 0;
      modal?.show();
    });
  }

  document.getElementById('btnSalvarResumoAtual')?.addEventListener('click', ()=>{
    const inpTotal = document.getElementById('inputTotalMes');
    const inpGasto = document.getElementById('inputGastoMesAtual');
    if(inpTotal) totalMes = parseFloat(inpTotal.value) || 0;
    if(inpGasto) gastoMes = parseFloat(inpGasto.value) || 0;
    atualizarResumo();
    // atualizar dashboards/graficos que dependem dos valores
    renderDashboard();
    gerarGraficoMensal();
    gerarGraficoAnual();
    modal?.hide();
  });
})();
</script>

</body>
</html>
